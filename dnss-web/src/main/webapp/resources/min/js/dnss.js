var dnss={skills:{},types:null,queue:[],messages:{},max_levels:null,max_sp:null,build:Array(72+1+1).join("-").split(""),positions:[],current:{},total_skills:$(".skill[data-id]").length,parsed_total:0,jobs:[],ultimates:[],building:false,init:function(d,b,e,f){this.jobs=d;this.max_levels=b;this.max_sp=e;if(f){var a=f.match(/^[0-9a-zA-Z-]+/g);var g=a.shift();if(g){g=g.split("");for(var c=0;c<g.length-1;c++){this.build[c]=g[c]}this.build[this.build.length-1]=g[g.length-1]}}$(".container").each(function(j){var h=$(this).find(".skill");if(h.length){h.data("position",j)}});$.getJSON("/json/types.json",function(h){dnss.types=h;while(dnss.queue.length){dnss.add_skills(dnss.queue.shift())}});for(var c in d){$.getJSON(fmt("/json/$0.json",d[c]),function(k){for(var h in k.messages){dnss.messages[h]=k.messages[h]}if(dnss.types){dnss.add_skills(k)}else{dnss.queue.push(k)}})}$("#mode").bind("click",function(){switch($(this).val()){case"pve":$(this).val("pvp");break;case"pvp":$(this).val("pve");break}description.flip()});$("#job-sp li[data-job]").each(function(){var h=$(this).data("job");$(this).click(function(){$('#job-sp li[data-job][class="active"]').removeClass("active");$(this).addClass("active");$(".skill-tree").hide();$("#skill-tree-"+h).show()})});$("#bimage").bind("click",function(){if(dnss.building){return false}dnss.working=true;var k=$(document.createElement("div"));k.css({position:"absolute",top:window.innerHeight+"px",left:0});for(var h=0;h<3;h++){var m=$(document.createElement("div"));var j=$("#sidebar-1").clone();var l=$("section").clone();m.css("clear","left");j.css("margin-left","10px").find("#warnings").hide();j.find(".active").removeClass("active");j.find("li[data-job="+h+"]").addClass("active");l.find(".skill-tree").hide();l.find("#skill-tree-"+h).show();m.append(j).append(l);k.append(m)}$("body").append(k);html2canvas(k,{onrendered:function(o){k.remove();dnss.building=false;var n=document.createElement("a");n.href=o.toDataURL("image/png");n.download=dnss.jobs[dnss.jobs.length-1]+".png";document.body.appendChild(n);n.click();document.body.removeChild(n)}});return false})},add_skills:function(a){var g=a.skills,h=a.default_skills,b=a.advancement;delete a.advancement;for(i in g){var k=g[i];var o=k.levels;delete k.levels;var d=0,n=false;if(h){for(var f=0;f<h.length;f++){if(h[f]==i){n=true;break}}}if(n){this.skills[i]=new Skill($.extend({},k,o[0],{level:1,advancement:b,id:i}));d++}else{this.skills[i]=new Skill($.extend({},k,{image:k.image+"_b",required_level:0,level:0,advancement:b,id:i}))}var p=this.skills[i],m=p,e,c=0;m=p;for(;d<o.length;d++){p.next=new Skill($.extend({},k,o[d],{level:d+1,advancement:b,id:i}));p.next.prev=p;p=p.next;c+=p.get_spcost();p.total_sp_cost=c;if(p.required_level<=this.max_levels[b]){m=p}}e=p;p=this.skills[i];while(p){p.start=this.skills[i];p.max=m;p.end=e;p=p.next}if(b==1&&this.skills[i].next&&this.skills[i].next.required_level==40&&this.skills[i].end.required_level==60){this.ultimates.push(i)}this.parsed_total++;this.set_starting_skill(i)}},get_skill:function(c,b){var a=this.skills[c];if(a.level==1&&b==0){return a}while(a.level!=b){a=a.next}return a},$:function(a){return $(".skill[data-id="+a+"]")},set_starting_skill:function(d){var c=this.$(d),a=c.data("position");var b=this.get_skill(d,this.skills[d].level+inv_build_map[this.build[a]]);b.bind(c);c.bind({mousedown:function(h){var f=$(this).data("skill"),j;var g=h.shiftKey||h.ctrlKey;if(h.button==0){if(g){if(f.level<f.max.level){j=f.max}}else{if(f.next){j=f.next}}}else{if(h.button==2){if(g){if(f.level!=f.start.level){j=f.start}}else{if(f.prev){j=f.prev}}}}if(j){description.use(j);j.bind($(this));dnss.update();requirements.check()}},mouseenter:function(){description.use($(this).data("skill"))}});c.on("contextmenu",function(){return false});if(this.parsed_total==this.total_skills){this.update();if(inv_build_map[this.build[this.build.length-1]]&1){$("#mode").trigger("click")}requirements.check()}},get_all_sp:function(){var b=[0,0,0];for(var a=0;a<72;a++){if(this.positions[a]){b[Math.floor(a/24)]+=this.positions[a].total_sp_cost}}return b},update:function(){var a=this.get_all_sp();for(i in a){$("#job-sp li[data-job="+i+"] .sp").html(a[i]+"/"+this.max_sp[i])}$("#job-sp li:last .sp").html(a[0]+a[1]+a[2]+"/"+this.max_sp[3]);this.update_build()},update_build:function(){var a=$("#build");a.val(fmt(a.data("base"),window.location)+"?"+this.build.join(""))}};